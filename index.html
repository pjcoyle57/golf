<html>
<head>
<style>
    table {
        font-family: Arial;
        border: blue solid;
        font-size: 16px;
        border-collapse: collapse;
    }
	td{
		border: blue solid;
	}
	.total{
		background-color: lightblue;
		font-weight: 800;
	}
</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script >
	
	// A list of players. Handicaps must align with the order of the players.
		var players = [
		"D Richmond",
		"T Steer",
        "A Thackrey",
        "A Turner"

	];
	
	// Handicaps for each player above. Order is important.
		var playerHandicaps = [
		[27, 27, 27, 27],                       // Heacham, Cromer, Sher, Sandy Lodge
		[21, 21, 21, 21],
        [27, 27, 27, 27],
        [22, 22, 22, 22]
	];
	
	// Course names. Each course also needs an entry in courseStrokeIndex and courseHolePar
		var courses = [
		"Heacham Manor",
		"Royal Cromer",
		"Sheringham",
		"Sandy Lodge"
	];

	var strokeIndex = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]
	
	// The stroke index for each hole on the course
	var courseStrokeIndex = [
		[4,9,17,13,12,1,11,16,5,7,2,15,6,8,14,10,18,3],    // Heacham
		[5,9,15,7,13,1,3,17,11,12,6,16,10,4,2,14,18,8],    // Cromer 
		[17,13,3,12,1,10,6,15,8,2,18,9,4,7,14,16,5,11],    // Sheringham
        [9,5,15,11,3,1,13,17,7,14,2,6,16,8,12,4,10,18]     // Sandy Lodge
	];
	
	// The par for each hole on the course.
	var courseHolePar = [
		[4,5,4,5,3,4,3,4,4,4,5,4,4,4,3,4,3,5],            // Heacham
		[4,4,4,4,5,4,4,4,3,5,5,4,3,4,4,4,3,4],            // Cromer
		[4,5,4,4,4,3,5,3,4,4,3,4,4,4,3,4,4,4],            // Sheringham 
        [5,4,3,5,4,4,3,3,4,3,5,4,4,5,3,4,5,3]             // Sandy Lodge
	];
	
$(document).ready(function(){

	// This bit just puts today's date in the date box as a default
	const today = new Date();
	const formattedDate = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
	document.getElementById('playDate').value = formattedDate;
	
	// Populate the Courses and Players
	
	for(var i = 0; i < courses.length; ++i)
	{
		$("#course").append(`<option value='${i}'">${courses[i]}</option>`)
	}
	for(var i = 0; i < players.length; ++i)
	{
		$("#player").append(`<option value='${i}'">${players[i]}</option>`)
	}

	// This part builds the table 

	// First 9 holes
	for(var i = 1; i <= 9; ++i)
	{
		$("#res").append(`
			<tr>
				<td>${i}</label>
				<td  style="width: 3rem; text-align: center;" id="hole${i}OrigPar"></td>
				<td  style="width: 3rem; text-align: center;" id="hole${i}SI"></td>
				<td><input disabled style="border: none; width: 5rem; font-weight: 700; font-size: 16px; text-align: center;" min="1" id="hole${i}Score" type=number class="holeScore" data-hole-num="${i}" /></td>
				<td  style="width: 3rem; text-align: center;" id="hole${i}Result" class="holeResult" data-hole-num="${i}" ></td>
			</tr>
		`)
	}
	
	// Out total
	$("#res").append(`
		<tr class="total">
			<td colspan=2 style="text-align: center;" id="totalParOut"></td>
			<td colspan=1 style="text-align: center;"><strong>Out</strong></label>
			<td id = "totalScoreOut" style="text-align: center;"></td>
			<td  style="text-align: center;" id="totalPointsOut"></td>
		</tr>
	`);
	
	// Back 9 holes
	for(var i = 10; i <= 18; ++i)
	{
		$("#res").append(`
			<tr>
				<td>${i}</label>
				<td  style="width: 3rem; text-align: center;" id="hole${i}OrigPar"></td>
				<td  style="width: 3rem; text-align: center;" id="hole${i}SI"></td>
				<td><input disabled style="border: none; width: 5rem; font-weight: 700; font-size: 16px; text-align: center;" min="1" id="hole${i}Score" type=number class="holeScore" data-hole-num="${i}" /></td>
				<td  style="width: 3rem; text-align: center;" id="hole${i}Result" class="holeResult" data-hole-num="${i}" ></td>
			</tr>
		`)
	}
	
	// In Total and Out Total (again)
	$("#res").append(`
			<tr class="total">
							<td colspan=2 style="text-align: center;" id="totalParIn"></td>
				<td colspan=1 style="text-align: center;"><strong>In</strong></label>
				<td id = "totalScoreIn" style="text-align: center;"></td>
				<td  style="text-align: center;" id="totalPointsIn"></td>
			</tr>
			<tr class="total">
				<td colspan=2 style="text-align: center;" id="totalParOut2"></td>
				<td colspan=1 style="text-align: center;"><strong>Out</strong></label>
				<td id = "totalScoreOut2" style="text-align: center;"></td>
				<td  style="text-align: center;" id="totalPointsOut2"></td>
			</tr>
		`);
		
	// Grand total again
	$("#res").append(`
		<tr class="total grandtotal">
			<td colspan=2 style="text-align: center;" id="totalPar"></td>
			<td colspan=1 style="text-align: center;"><strong>Total</strong></label>
			<td id="totalScore" style="text-align: center;"></td>
			<td  style="text-align: center;" id="totalPoints"></td>
		</tr>
	`);
	
	// Block to allow player to move past last entry
	$("#res").append(`
		<tr class="total grandtotal">
			<td colspan=5 ;">
				<button type="button" id="finalCheck" style="height: 60px; width: 100%;">
					<strong style="font-size: big;">Final Check</strong>
				</button>
			</td>
		</tr>
	`);
    // Email results button
    $("#res").append(`
		<tr class="total grandtotal">
			<td colspan=5 ;">
				<button type="button" disabled id="emailResults" style="height: 60px; width: 100%;">
					<strong style="font-size: big;">Email to Dave Richmond >>>>>>></strong>
				</button>
			</td>
		</tr>
	`);
	// Logic to put the handicap in when the play is changed
	
	$("#player").off("change").on("change", function(e){
		var optionSelected = $("#player").val();
		if(optionSelected < playerHandicaps.length)
			$("#handicap").val(playerHandicaps[optionSelected][$("#course").val()]);
	});
	
	$("#finalCheck").on("click", function(){
		for(var i = 0; i < 18; ++i){
			let holeVal =  $(`#hole${i+1}Score`).val();
			let holeInt = parseInt(holeVal ,10);
			if(holeInt < 0 || holeInt >= 10)
			{
				$("#emailResults").attr("disabled", true);
				alert("You have missed some entries.");
				return false;
			}
		}
		$("#emailResults").attr("disabled", false);

	})
	
	$("#course").off("change").on("change", function(e){
		var optionSelected = $("#course").val();
		if(optionSelected < courses.length)
		{
			$("#handicap").val(playerHandicaps[$("#player").val()][optionSelected]);
		}
	});
	
	// Holds the stableford points
	var stableford_points = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	
	// This is the function that actually calculates the points, totals and everything.
	$(".holeScore").on("change", function(){
		var player_handicap = $("#handicap").val();
		var player_handicap_work = 0;

		var total_score = 0;
		var total_score_in = 0;
		var total_score_out = 0;
		var total_pts = 0;
		var total_pts_in = 0;
		var total_pts_out = 0;
		var total_par = 0;
		var total_par_in = 0;
		var total_par_out = 0;


		var course_index = $("#course").val();
		
		// check that enough data is completed
		
		if(course_index >= 0 && player_handicap > 0 && $("#player").val() != "" )
			{
				$(".holeScore").attr("disabled", false);
				$("#handicap").attr("disabled", true);
			}
		

		for(var i = 0; i < 18; ++i){
			
			hole_stroke_index = courseStrokeIndex[course_index][i];
			player_handicap_work = player_handicap;     // reset handicap for every hole
			var player_par = courseHolePar[course_index][i];  // get the par for the hole
			if(i < 9)
				total_par_out += player_par;
			else
				total_par_in += player_par;
			total_par += player_par;
			$(`#hole${i+1}OrigPar`).text(player_par);
			while (player_handicap_work > 18)
				 { player_par++;              // change the par for the hole based on handicap
				   player_handicap_work = player_handicap_work - 18;     // reduce  
				 }  
			// now look at stroke index and see where we are
			if (hole_stroke_index <= player_handicap_work)
				 player_par++;              // change the par for the hole based on below or equal to stroke index
		 
			$(`#hole${i+1}SI`).text(hole_stroke_index);
			var score = parseInt($(`#hole${i+1}Score`).val(), 10);
			if(isNaN(score))
				score = 0;
				//console.log("Score", score);
			var points = parseInt($(`#hole${i+1}Result`).text(), 10);
			if(isNaN(points))
				points = 0;
			if(score != 0)
			{
				stableford_points[i] = (player_par + 2 - $(`#hole${i+1}Score`).val());
				 if (stableford_points[i] < 0)
					  stableford_points[i] = 0;  
				 $(`#hole${i+1}Result`).text(stableford_points[i]);

				 total_score += score;
				 total_pts += stableford_points[i];
				 if(i < 9)
				 {
					total_score_out += score;
						total_pts_out += stableford_points[i];
				}
					else
					{
						total_score_in += score;
						total_pts_in += stableford_points[i];
					}
				 console.log(total_score);
			 }
		}
		$("#totalScore").text(total_score);
		$("#totalScoreIn").text(total_score_in);
		$("#totalScoreOut").text(total_score_out);
		$("#totalScoreOut2").text(total_score_out);
		$("#totalPoints").text(total_pts);
		$("#totalPointsIn").text(total_pts_in);
		$("#totalPointsOut2").text(total_pts_out);
		$("#totalPointsOut").text(total_pts_out);
		$("#totalPar").text(total_par);
		$("#totalParIn").text(total_par_in);
		$("#totalParOut").text(total_par_out);
		$("#totalParOut2").text(total_par_out);


		console.dir(stableford_points);
	});
	
	// This function sends the email
	
	$("#emailResults").on("click", function(){
		
        var link =`mailto:dave@richmond35.com?cc=andrew@aturner.co.uk?subject=Stableford for ${$("#player option:selected").text()} at ${$("#course option:selected").text()} on ${$("#playDate").val()}`;
		var s_text = "Score";
        var p_text = "Points";
        var s = "";
        var p = "";
		var s_end = "";
        var p_end = "";

		for (var i = 1; i <= 18; ++i)
		{
			s += "%09";
			s += $(`#hole${i}Score`).val() == "" ? 0 :  $(`#hole${i}Score`).val();
			p += "%09";
			p += $(`#hole${i}Result`).text() == "" ? 0 : $(`#hole${i}Result`).text() ;
		}
		
		s_end += "%09Out%09";		
		s_end += $(`#totalScoreOut`).text() == "" ? 0 :  $(`#totalScoreOut`).text();
		s_end += "%09In%09";		
		s_end += $(`#totalScoreIn`).text() == "" ? 0 :  $(`#totalScoreIn`).text();
		s_end += "%09Total%09";		
		s_end += $(`#totalScore`).text() == "" ? 0 :  $(`#totalScore`).text();

		p_end += "%09Out%09";		
		p_end += $(`#totalPointsOut`).text() == "" ? 0 :  $(`#totalPointsOut`).text();
		p_end += "%09In%09";		
		p_end += $(`#totalPointsIn`).text() == "" ? 0 :  $(`#totalPointsIn`).text();
		p_end += "%09Total%09";		
		p_end += $(`#totalPoints`).text() == "" ? 0 :  $(`#totalPoints`).text();


        link += `&body=Handicap ${$("#handicap").val()}%0D%0A${s_text}%0D%0A${s}%0D%0A${s_end}%0D%0A${p_text}%0D%0A${p}%0D%0A${p_end}`;
		console.log(link);
		window.open(link);
	});
})
</script>
</head>
<body>
<div>
	<table>
		<tr>
			<td><input type="date" id="playDate" style="border: none; font-weight: 500; font-size: 16px; text-align: center;" /> </td>
		</tr>
		<tr>
			<td>Course</td>
			<td>
				<select id="course" placeholder="Please Select Course" class="holeScore">
					<option value="-1">Please Select Course</option>

				</select>
			</td>
		</tr>
		<tr>
			<td>Player Name</td>
			<td>
				<select id="player" class="holeScore">
					<option value="-1">Please Select Player</option>
				</select>
			</td>
		</tr>
		<tr>
			<td>Handicap</td>
			<td>
				<input disabled id="handicap" type="number" style="border: none; font-weight: 700; font-size: 16px; text-align: center;" class="holeScore" />
			</td>
		</tr>
	</table>
	<table id="res">
		<tr>
			<th>Hole</th>
			<th>Par</th>
			<th>SI</th>
			<th>Score</th>
			<th>Points</th>
		</tr>
</table>


	
	

</body>


</html>